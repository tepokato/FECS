(function(global){
  class BrowserMultiFormatReader {
    constructor() {
      this.detector = 'BarcodeDetector' in global ? new BarcodeDetector() : null;
      this._stream = null;
      this._stopped = true;
    }
    async decodeFromVideoDevice(deviceId, video, callback) {
      if (!this.detector) {
        throw new Error('BarcodeDetector API not supported');
      }
      if (typeof video === 'string') {
        video = document.getElementById(video);
      }
      this._stopped = false;
      this._stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      video.srcObject = this._stream;
      await video.play();
      const scan = async () => {
        if (this._stopped) return;
        try {
          const codes = await this.detector.detect(video);
          if (codes.length > 0) {
            callback({ getText: () => codes[0].rawValue }, null);
            return;
          }
        } catch (err) {
          callback(null, err);
          return;
        }
        requestAnimationFrame(scan);
      };
      scan();
    }
    reset() {
      this._stopped = true;
      if (this._stream) {
        this._stream.getTracks().forEach(t => t.stop());
        this._stream = null;
      }
    }
  }
  global.ZXing = { BrowserMultiFormatReader };
})(window);
